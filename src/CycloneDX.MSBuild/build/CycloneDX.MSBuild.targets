<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- CycloneDX.MSBuild Targets -->

  <!-- Target execution order:
       1. ValidateCycloneDxConfiguration (before build)
       2. EnsureCycloneDxToolInstalled (before SBOM generation)
       3. GenerateCycloneDxMetadata (before SBOM generation if metadata requested)
       4. GenerateCycloneDxSbom (after build, before pack)
  -->

  <Target Name="ValidateCycloneDxConfiguration"
          BeforeTargets="Build"
          Condition="'$(GenerateCycloneDxSbom)' == 'true'">
    <PropertyGroup>
      <_CycloneDxValidationFailed>false</_CycloneDxValidationFailed>
    </PropertyGroup>
    <Warning Condition="'$(CycloneDxOutputFormat)' != 'json' AND '$(CycloneDxOutputFormat)' != 'xml'"
             Text="[CycloneDX] Invalid output format '$(CycloneDxOutputFormat)'. Supported formats: json, xml. Defaulting to json." />
    <PropertyGroup Condition="'$(CycloneDxOutputFormat)' != 'json' AND '$(CycloneDxOutputFormat)' != 'xml'">
      <CycloneDxOutputFormat>json</CycloneDxOutputFormat>
    </PropertyGroup>
    <MakeDir Directories="$(CycloneDxOutputDirectory)" Condition="!Exists('$(CycloneDxOutputDirectory)')" />
    <Message Importance="low" Text="[CycloneDX] Configuration validated successfully" />
  </Target>

  <Target Name="EnsureCycloneDxToolInstalled"
          BeforeTargets="GenerateCycloneDxSbom"
          Condition="'$(GenerateCycloneDxSbom)' == 'true'">
    <PropertyGroup>
      <_CycloneDxConfigDir>$(MSBuildProjectDirectory)/.config</_CycloneDxConfigDir>
      <_CycloneDxToolManifest>$(_CycloneDxConfigDir)/dotnet-tools.json</_CycloneDxToolManifest>
    </PropertyGroup>
    <MakeDir Directories="$(_CycloneDxConfigDir)" Condition="!Exists('$(_CycloneDxConfigDir)')" />
    <Exec Command="dotnet new tool-manifest"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          Condition="!Exists('$(_CycloneDxToolManifest)')"
          ContinueOnError="$(CycloneDxContinueOnError)"
          StandardOutputImportance="low"
          StandardErrorImportance="normal">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxManifestExitCode" />
    </Exec>
    <Message Importance="normal" Text="[CycloneDX] Installing CycloneDX tool version $(CycloneDxToolVersion)..." />
    <Exec Command="dotnet tool install --local CycloneDX --version $(CycloneDxToolVersion)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ContinueOnError="true"
          StandardOutputImportance="low"
          StandardErrorImportance="low">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxInstallExitCode" />
    </Exec>
    <Exec Command="dotnet tool restore"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          Condition="'$(_CycloneDxInstallExitCode)' != '0'"
          ContinueOnError="$(CycloneDxContinueOnError)"
          StandardOutputImportance="low"
          StandardErrorImportance="normal">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxRestoreExitCode" />
    </Exec>
    <Message Importance="low" Text="[CycloneDX] Tool installation/restore completed" />
  </Target>

  <Target Name="GenerateCycloneDxMetadata"
          BeforeTargets="GenerateCycloneDxSbom"
          Condition="'$(GenerateCycloneDxSbom)' == 'true' AND '$(CycloneDxGenerateMetadata)' == 'true' AND '$(CycloneDxImportMetadataPath)' == ''">
    <PropertyGroup>
      <_CycloneDxTempMetadataPath>$(IntermediateOutputPath)cyclonedx-metadata.xml</_CycloneDxTempMetadataPath>
      <_CycloneDxVersion Condition="'$(Version)' != ''">$(Version)</_CycloneDxVersion>
      <_CycloneDxVersion Condition="'$(_CycloneDxVersion)' == '' AND '$(VersionPrefix)' != ''">$(VersionPrefix)</_CycloneDxVersion>
      <_CycloneDxVersion Condition="'$(_CycloneDxVersion)' == '' AND '$(AssemblyVersion)' != ''">$(AssemblyVersion)</_CycloneDxVersion>
      <_CycloneDxVersion Condition="'$(_CycloneDxVersion)' == '' AND '$(GitVersion_FullSemVer)' != ''">$(GitVersion_FullSemVer)</_CycloneDxVersion>
      <_CycloneDxVersion Condition="'$(_CycloneDxVersion)' == '' AND '$(GitVersion_SemVer)' != ''">$(GitVersion_SemVer)</_CycloneDxVersion>
      <_CycloneDxVersion Condition="'$(_CycloneDxVersion)' == ''">1.0.0</_CycloneDxVersion>
      <_CycloneDxComponentName Condition="'$(AssemblyName)' != ''">$(AssemblyName)</_CycloneDxComponentName>
      <_CycloneDxComponentName Condition="'$(_CycloneDxComponentName)' == ''">$(MSBuildProjectName)</_CycloneDxComponentName>
      <_CycloneDxAuthors Condition="'$(Authors)' != ''">$(Authors)</_CycloneDxAuthors>
      <_CycloneDxAuthors Condition="'$(_CycloneDxAuthors)' == '' AND '$(Company)' != ''">$(Company)</_CycloneDxAuthors>
      <_CycloneDxDescription Condition="'$(Description)' != ''">$(Description)</_CycloneDxDescription>
      <_CycloneDxDescription Condition="'$(_CycloneDxDescription)' == '' AND '$(PackageDescription)' != ''">$(PackageDescription)</_CycloneDxDescription>
      <_CycloneDxCopyright Condition="'$(Copyright)' != ''">$(Copyright)</_CycloneDxCopyright>
      <_CycloneDxLicense Condition="'$(PackageLicenseExpression)' != ''">$(PackageLicenseExpression)</_CycloneDxLicense>
    </PropertyGroup>

    <!-- Build metadata XML content using raw values (no inline tasks) -->
    <PropertyGroup>
      <_CycloneDxPurl>pkg:nuget/$(_CycloneDxComponentName)@$(_CycloneDxVersion)</_CycloneDxPurl>
      <_CycloneDxMetadataContent>&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;bom xmlns="http://cyclonedx.org/schema/bom/1.6"&gt;&lt;metadata&gt;&lt;component type="application" bom-ref="$(_CycloneDxPurl)"&gt;&lt;name&gt;$(_CycloneDxComponentName)&lt;/name&gt;&lt;version&gt;$(_CycloneDxVersion)&lt;/version&gt;</_CycloneDxMetadataContent>
      <_CycloneDxMetadataContent Condition="'$(_CycloneDxDescription)' != ''">$(_CycloneDxMetadataContent)&lt;description&gt;$(_CycloneDxDescription)&lt;/description&gt;</_CycloneDxMetadataContent>
      <_CycloneDxMetadataContent Condition="'$(_CycloneDxAuthors)' != ''">$(_CycloneDxMetadataContent)&lt;supplier&gt;&lt;name&gt;$(_CycloneDxAuthors)&lt;/name&gt;&lt;/supplier&gt;</_CycloneDxMetadataContent>
      <_CycloneDxMetadataContent Condition="'$(_CycloneDxCopyright)' != ''">$(_CycloneDxMetadataContent)&lt;copyright&gt;$(_CycloneDxCopyright)&lt;/copyright&gt;</_CycloneDxMetadataContent>
      <_CycloneDxMetadataContent Condition="'$(_CycloneDxLicense)' != ''">$(_CycloneDxMetadataContent)&lt;licenses&gt;&lt;license&gt;&lt;id&gt;$(_CycloneDxLicense)&lt;/id&gt;&lt;/license&gt;&lt;/licenses&gt;</_CycloneDxMetadataContent>
      <_CycloneDxMetadataContent>$(_CycloneDxMetadataContent)&lt;purl&gt;$(_CycloneDxPurl)&lt;/purl&gt;&lt;/component&gt;&lt;/metadata&gt;&lt;/bom&gt;</_CycloneDxMetadataContent>
    </PropertyGroup>

    <WriteLinesToFile File="$(_CycloneDxTempMetadataPath)"
                      Lines="$(_CycloneDxMetadataContent)"
                      Overwrite="true"
                      WriteOnlyWhenDifferent="true" />

    <PropertyGroup>
      <CycloneDxImportMetadataPath>$(_CycloneDxTempMetadataPath)</CycloneDxImportMetadataPath>
    </PropertyGroup>

    <Message Importance="low" Text="[CycloneDX] Metadata template generated: $(_CycloneDxTempMetadataPath)" />
  </Target>

  <Target Name="GenerateCycloneDxSbom"
          AfterTargets="Build"
          Condition="'$(GenerateCycloneDxSbom)' == 'true'">
    <Message Importance="high" Text="[CycloneDX] Generating SBOM for $(MSBuildProjectName)..." />
    <PropertyGroup>
      <CycloneDxOutputDirectory Condition="'$(CycloneDxOutputDirectory)' == ''">$(OutputPath)</CycloneDxOutputDirectory>
      <CycloneDxOutputDirectory>$(CycloneDxOutputDirectory.TrimEnd('\').TrimEnd('/'))</CycloneDxOutputDirectory>
    </PropertyGroup>
    <PropertyGroup>
      <_CycloneDxArgs></_CycloneDxArgs>
      <_CycloneDxArgs>$(_CycloneDxArgs) "$(MSBuildProjectFullPath)"</_CycloneDxArgs>
      <_CycloneDxArgs>$(_CycloneDxArgs) -o "$(CycloneDxOutputDirectory)"</_CycloneDxArgs>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'json'">$(CycloneDxOutputFilename).json</_CycloneDxFullFilename>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'xml'">$(CycloneDxOutputFilename).xml</_CycloneDxFullFilename>
      <_CycloneDxFullFilename Condition="'$(_CycloneDxFullFilename)' == ''">$(CycloneDxOutputFilename).json</_CycloneDxFullFilename>
      <_CycloneDxArgs>$(_CycloneDxArgs) -fn "$(_CycloneDxFullFilename)"</_CycloneDxArgs>
      <!-- Calculate the full output path with proper path separator -->
      <CycloneDxOutputPath>$([System.IO.Path]::Combine('$(CycloneDxOutputDirectory)', '$(_CycloneDxFullFilename)'))</CycloneDxOutputPath>
      <_CycloneDxOutputFormat Condition="'$(CycloneDxOutputFormat)' == 'json'">Json</_CycloneDxOutputFormat>
      <_CycloneDxOutputFormat Condition="'$(CycloneDxOutputFormat)' == 'xml'">Xml</_CycloneDxOutputFormat>
      <_CycloneDxOutputFormat Condition="'$(_CycloneDxOutputFormat)' == ''">Json</_CycloneDxOutputFormat>
      <_CycloneDxArgs>$(_CycloneDxArgs) -F $(_CycloneDxOutputFormat)</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxExcludeDev)' == 'true'">$(_CycloneDxArgs) -ed</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxExcludeTestProjects)' == 'true'">$(_CycloneDxArgs) -t</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxDisableSerialNumber)' == 'true'">$(_CycloneDxArgs) -ns</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxEnableGitHubLicenses)' == 'true'">$(_CycloneDxArgs) -egl</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxGitHubUsername)' != ''">$(_CycloneDxArgs) -gu "$(CycloneDxGitHubUsername)"</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxGitHubToken)' != ''">$(_CycloneDxArgs) -gt "$(CycloneDxGitHubToken)"</_CycloneDxArgs>
      <_CycloneDxArgs Condition="'$(CycloneDxImportMetadataPath)' != ''">$(_CycloneDxArgs) -imp "$(CycloneDxImportMetadataPath)"</_CycloneDxArgs>
    </PropertyGroup>
    <Exec Command="dotnet cyclonedx $(_CycloneDxArgs)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ContinueOnError="$(CycloneDxContinueOnError)"
          StandardOutputImportance="normal"
          StandardErrorImportance="high">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxGenerateExitCode" />
    </Exec>
    <Message Importance="high" Condition="'$(_CycloneDxGenerateExitCode)' == '0'" Text="[CycloneDX] SBOM generated successfully: $(CycloneDxOutputPath)" />
    <Warning Condition="'$(_CycloneDxGenerateExitCode)' != '0' AND '$(CycloneDxContinueOnError)' == 'true'" Text="[CycloneDX] SBOM generation failed with exit code $(_CycloneDxGenerateExitCode). Build continuing due to CycloneDxContinueOnError=true" />
    <Error Condition="'$(_CycloneDxGenerateExitCode)' != '0' AND '$(CycloneDxContinueOnError)' == 'false'" Text="[CycloneDX] SBOM generation failed with exit code $(_CycloneDxGenerateExitCode)" />
  </Target>

  <UsingTask TaskName="EnsureSbomVersionField" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <SbomPath ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.IO" />
      <Using Namespace="System.Text.Json" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        try
        {
            var jsonString = File.ReadAllText(SbomPath);
            var options = new JsonDocumentOptions { AllowTrailingCommas = true };
            using var document = JsonDocument.Parse(jsonString, options);
            var root = document.RootElement;

            // Check if version field exists
            if (!root.TryGetProperty("version", out _))
            {
                // Create a new JSON object with version field
                using var outputStream = new MemoryStream();
                using (var writer = new Utf8JsonWriter(outputStream, new JsonWriterOptions { Indented = true }))
                {
                    writer.WriteStartObject();

                    // Write version field first
                    writer.WriteNumber("version", 1);

                    // Copy all existing properties from the already-parsed document
                    foreach (var property in root.EnumerateObject())
                    {
                        property.WriteTo(writer);
                    }

                    writer.WriteEndObject();
                }

                // Write back to file
                File.WriteAllBytes(SbomPath, outputStream.ToArray());
                Log.LogMessage(MessageImportance.Low, "[CycloneDX] Added version field to SBOM");
            }
            else
            {
                Log.LogMessage(MessageImportance.Low, "[CycloneDX] SBOM already has version field");
            }
        }
        catch (Exception ex)
        {
            Log.LogWarning($"[CycloneDX] Failed to ensure version field: {ex.Message}");
        }
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="EnsureCycloneDxSbomVersion"
          AfterTargets="GenerateCycloneDxSbom"
          Condition="'$(GenerateCycloneDxSbom)' == 'true' AND '$(_CycloneDxGenerateExitCode)' == '0' AND Exists('$(CycloneDxOutputPath)') AND '$(CycloneDxOutputFormat)' == 'json'">
    <Message Importance="low" Text="[CycloneDX] Ensuring SBOM has version field at $(CycloneDxOutputPath)..." />
    <EnsureSbomVersionField SbomPath="$(CycloneDxOutputPath)" />
  </Target>

  <Target Name="IncludeCycloneDxSbomInPackage"
          BeforeTargets="GenerateNuspec"
          Condition="'$(GenerateCycloneDxSbom)' == 'true' AND '$(IsPackable)' != 'false'">
    <PropertyGroup>
      <!-- Recalculate output path in case it wasn't set -->
      <CycloneDxOutputDirectory Condition="'$(CycloneDxOutputDirectory)' == ''">$(OutputPath)</CycloneDxOutputDirectory>
      <CycloneDxOutputDirectory>$(CycloneDxOutputDirectory.TrimEnd('\').TrimEnd('/'))</CycloneDxOutputDirectory>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'json' OR '$(CycloneDxOutputFormat)' == ''">$(CycloneDxOutputFilename).json</_CycloneDxFullFilename>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'xml'">$(CycloneDxOutputFilename).xml</_CycloneDxFullFilename>
      <CycloneDxOutputPath>$([System.IO.Path]::Combine('$(CycloneDxOutputDirectory)', '$(_CycloneDxFullFilename)'))</CycloneDxOutputPath>
    </PropertyGroup>
    <ItemGroup>
      <None Include="$(CycloneDxOutputPath)" Pack="true" PackagePath="sbom/" Condition="Exists('$(CycloneDxOutputPath)')" />
    </ItemGroup>
    <Message Importance="normal" Condition="Exists('$(CycloneDxOutputPath)')" Text="[CycloneDX] Including SBOM in NuGet package: $(CycloneDxOutputPath)" />
  </Target>

  <Target Name="CopyCycloneDxSbomToPublishDirectory"
          AfterTargets="Publish"
          Condition="'$(PublishDir)' != ''">
    <!-- Check if SBOM was enabled (either for this build or for outer build in multi-target scenario) -->
    <PropertyGroup>
      <_CycloneDxShouldCopyToPublish Condition="'$(GenerateCycloneDxSbom)' == 'true' OR '$(_CycloneDxIsInnerBuild)' == 'true'">true</_CycloneDxShouldCopyToPublish>
    </PropertyGroup>

    <PropertyGroup Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true'">
      <!-- Recalculate output directory and paths in case they weren't set -->
      <CycloneDxOutputDirectory Condition="'$(CycloneDxOutputDirectory)' == ''">$(OutputPath)</CycloneDxOutputDirectory>
      <CycloneDxOutputDirectory>$(CycloneDxOutputDirectory.TrimEnd('\').TrimEnd('/'))</CycloneDxOutputDirectory>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'json' OR '$(CycloneDxOutputFormat)' == ''">$(CycloneDxOutputFilename).json</_CycloneDxFullFilename>
      <_CycloneDxFullFilename Condition="'$(CycloneDxOutputFormat)' == 'xml'">$(CycloneDxOutputFilename).xml</_CycloneDxFullFilename>
      <CycloneDxOutputPath>$([System.IO.Path]::Combine('$(CycloneDxOutputDirectory)', '$(_CycloneDxFullFilename)'))</CycloneDxOutputPath>
      <_CycloneDxPublishPath>$([System.IO.Path]::Combine('$(PublishDir)', '$(_CycloneDxFullFilename)'))</_CycloneDxPublishPath>
    </PropertyGroup>

    <Message Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true'" Importance="high" Text="[CycloneDX] Publish SBOM copy - OutputDir: $(CycloneDxOutputDirectory), OutputPath: $(CycloneDxOutputPath), PublishDir: $(PublishDir), Exists: $([System.IO.File]::Exists('$(CycloneDxOutputPath)'))" />
    <Message Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true'" Importance="normal" Text="[CycloneDX] Copying SBOM from $(CycloneDxOutputPath) to publish directory..." />
    <Copy SourceFiles="$(CycloneDxOutputPath)"
          DestinationFiles="$(_CycloneDxPublishPath)"
          SkipUnchangedFiles="true"
          Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true' AND Exists('$(CycloneDxOutputPath)')" />
    <Message Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true' AND Exists('$(CycloneDxOutputPath)')" Importance="high" Text="[CycloneDX] SBOM copied to publish directory: $(_CycloneDxPublishPath)" />
    <Warning Condition="'$(_CycloneDxShouldCopyToPublish)' == 'true' AND !Exists('$(CycloneDxOutputPath)')" Text="[CycloneDX] SBOM file not found at $(CycloneDxOutputPath). Ensure build was successful before publishing." />
  </Target>

  <!-- Optional: Validate generated SBOM against CycloneDX schema -->
  <Target Name="ValidateCycloneDxSbom"
          AfterTargets="GenerateCycloneDxSbom"
          Condition="'$(CycloneDxValidateSbom)' == 'true' AND Exists('$(CycloneDxOutputPath)')">

    <Message Importance="normal" Text="[CycloneDX] Validating SBOM against CycloneDX schema..." />

    <!-- Check if cyclonedx-cli is available -->
    <Exec
      Command="npx --version"
      ContinueOnError="true"
      StandardOutputImportance="low"
      StandardErrorImportance="low"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxNpxAvailable" />
    </Exec>

    <Warning
      Condition="'$(_CycloneDxNpxAvailable)' != '0'"
      Text="[CycloneDX] npx not found. SBOM validation requires npm and @cyclonedx/cyclonedx-cli. Skipping validation." />

    <!-- Validate SBOM using cyclonedx-cli -->
    <Exec
      Command="npx --yes @cyclonedx/cyclonedx-cli validate --input-file &quot;$(CycloneDxOutputPath)&quot;"
      Condition="'$(_CycloneDxNpxAvailable)' == '0'"
      ContinueOnError="$(CycloneDxContinueOnError)"
      StandardOutputImportance="normal"
      StandardErrorImportance="high">
      <Output TaskParameter="ExitCode" PropertyName="_CycloneDxValidateExitCode" />
    </Exec>

    <Message
      Importance="high"
      Condition="'$(_CycloneDxValidateExitCode)' == '0'"
      Text="[CycloneDX] SBOM validation passed successfully!" />

    <Warning
      Condition="'$(_CycloneDxValidateExitCode)' != '0' AND '$(CycloneDxContinueOnError)' == 'true'"
      Text="[CycloneDX] SBOM validation failed. Build continuing due to CycloneDxContinueOnError=true" />

    <Error
      Condition="'$(_CycloneDxValidateExitCode)' != '0' AND '$(CycloneDxContinueOnError)' == 'false'"
      Text="[CycloneDX] SBOM validation failed. Fix validation errors or set CycloneDxContinueOnError=true" />

  </Target>

  <!-- Optional: Check if SBOM needs regeneration (incremental build support) -->
  <Target Name="CheckCycloneDxIncrementalBuild"
          BeforeTargets="GenerateCycloneDxSbom"
          Condition="'$(CycloneDxEnableIncrementalBuild)' == 'true' AND '$(GenerateCycloneDxSbom)' == 'true'">

    <!-- Compute a hash of project dependencies to detect changes -->
    <PropertyGroup>
      <_CycloneDxDependenciesHash>$(MSBuildProjectFullPath).CycloneDxDependenciesHash</_CycloneDxDependenciesHash>
      <_CycloneDxCurrentHash></_CycloneDxCurrentHash>
    </PropertyGroup>

    <!-- Get current project file and packages.lock.json modification times as a simple hash -->
    <ItemGroup>
      <_CycloneDxDependencyFiles Include="$(MSBuildProjectFullPath)" />
      <_CycloneDxDependencyFiles Include="$(MSBuildProjectDirectory)/packages.lock.json" Condition="Exists('$(MSBuildProjectDirectory)/packages.lock.json')" />
      <_CycloneDxDependencyFiles Include="$(MSBuildProjectDirectory)/obj/project.assets.json" Condition="Exists('$(MSBuildProjectDirectory)/obj/project.assets.json')" />
    </ItemGroup>

    <!-- Hash based on file modification times -->
    <Hash ItemsToHash="@(_CycloneDxDependencyFiles)">
      <Output TaskParameter="HashResult" PropertyName="_CycloneDxCurrentHash" />
    </Hash>

    <!-- Read previous hash if exists -->
    <ReadLinesFromFile
      File="$(_CycloneDxDependenciesHash)"
      Condition="Exists('$(_CycloneDxDependenciesHash)')">
      <Output TaskParameter="Lines" PropertyName="_CycloneDxPreviousHash" />
    </ReadLinesFromFile>

    <!-- Compare hashes -->
    <PropertyGroup>
      <_CycloneDxDependenciesChanged Condition="'$(_CycloneDxCurrentHash)' != '$(_CycloneDxPreviousHash)'">true</_CycloneDxDependenciesChanged>
      <_CycloneDxDependenciesChanged Condition="'$(_CycloneDxCurrentHash)' == '$(_CycloneDxPreviousHash)'">false</_CycloneDxDependenciesChanged>
      <_CycloneDxSbomExists Condition="Exists('$(CycloneDxOutputPath)')">true</_CycloneDxSbomExists>
      <_CycloneDxSbomExists Condition="!Exists('$(CycloneDxOutputPath)')">false</_CycloneDxSbomExists>
    </PropertyGroup>

    <!-- Skip generation if dependencies haven't changed and SBOM exists -->
    <PropertyGroup Condition="'$(_CycloneDxDependenciesChanged)' == 'false' AND '$(_CycloneDxSbomExists)' == 'true'">
      <GenerateCycloneDxSbom>false</GenerateCycloneDxSbom>
    </PropertyGroup>

    <Message
      Importance="normal"
      Condition="'$(_CycloneDxDependenciesChanged)' == 'false' AND '$(_CycloneDxSbomExists)' == 'true'"
      Text="[CycloneDX] Skipping SBOM generation - dependencies unchanged and SBOM exists" />

    <Message
      Importance="normal"
      Condition="'$(_CycloneDxDependenciesChanged)' == 'true' OR '$(_CycloneDxSbomExists)' == 'false'"
      Text="[CycloneDX] Dependencies changed or SBOM missing - will regenerate SBOM" />

  </Target>

  <!-- Save dependency hash after successful SBOM generation -->
  <Target Name="SaveCycloneDxDependenciesHash"
          AfterTargets="GenerateCycloneDxSbom"
          Condition="'$(CycloneDxEnableIncrementalBuild)' == 'true' AND '$(_CycloneDxGenerateExitCode)' == '0'">

    <PropertyGroup>
      <_CycloneDxDependenciesHash>$(MSBuildProjectFullPath).CycloneDxDependenciesHash</_CycloneDxDependenciesHash>
    </PropertyGroup>

    <!-- Save current hash for next build -->
    <WriteLinesToFile
      File="$(_CycloneDxDependenciesHash)"
      Lines="$(_CycloneDxCurrentHash)"
      Overwrite="true"
      Condition="'$(_CycloneDxCurrentHash)' != ''" />

  </Target>

</Project>
